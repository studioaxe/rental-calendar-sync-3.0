name: Rental Calendar Sync - Full Auto (6h)

on:
  schedule:
    # Executa a cada 6 horas (0:00, 6:00, 12:00, 18:00 UTC)
    - cron: '0 0,6,12,18 * * *'
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  sync-calendars:
    runs-on: ubuntu-latest

    steps:
      # ==================== SETUP ====================

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install icalendar requests python-dotenv pytz

      # ==================== SINCRONIZAÃ‡ÃƒO ====================

      - name: ðŸ”„ Run Calendar Sync
        id: sync
        env:
          AIRBNB_ICAL_URL: ${{ secrets.AIRBNB_ICAL_URL }}
          BOOKING_ICAL_URL: ${{ secrets.BOOKING_ICAL_URL }}
          VRBO_ICAL_URL: ${{ secrets.VRBO_ICAL_URL }}
          BUFFER_DAYS_BEFORE: 1
          BUFFER_DAYS_AFTER: 1
          OUTPUT_FILE: master_calendar.ics
          EMAIL_ON_ERROR: 'true'
          ERROR_EMAIL: ${{ secrets.ERROR_EMAIL }}
        run: |
          python scripts/sync_calendars.py
          echo "sync_status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      # ==================== UPLOAD ====================

      - name: ðŸ“¤ Upload master_calendar.ics to GitHub
        if: steps.sync.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: master_calendar
          path: master_calendar.ics
          retention-days: 30

      - name: ðŸ“Š Upload sync.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync_logs
          path: sync.log
          retention-days: 30

      # ==================== GIT COMMIT ====================

      - name: ðŸ”§ Configure Git
        if: steps.sync.outcome == 'success'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ðŸ“ Commit and Push master_calendar.ics
        if: steps.sync.outcome == 'success'
        id: git_commit
        run: |
          echo "=== Verificando ficheiro ==="
          if [ ! -f master_calendar.ics ]; then
            echo "âŒ ERRO: Ficheiro master_calendar.ics nÃ£o encontrado!"
            exit 1
          fi
          
          ls -lh master_calendar.ics
          echo ""
          
          echo "=== Git Status ==="
          git status
          echo ""
          
          echo "=== Adicionando ficheiro ==="
          git add master_calendar.ics
          
          echo "=== Git Diff ==="
          git diff --cached master_calendar.ics
          echo ""
          
          echo "=== Fazendo commit ==="
          if git commit -m "ðŸ—“ï¸ Auto-sync: master_calendar.ics atualizado - $(date '+%d/%m/%Y %H:%M:%S')"; then
            echo "âœ… Commit realizado com sucesso"
            
            echo ""
            echo "=== Fazendo push ==="
            if git push origin main; then
              echo "âœ… Push realizado com sucesso"
              echo "commit_status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ ERRO: Push falhou"
              echo "commit_status=push_failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âš ï¸  Nenhuma mudanÃ§a para commit (ficheiro jÃ¡ estava atualizado)"
            echo "commit_status=no_changes" >> $GITHUB_OUTPUT
          fi

      # ==================== PREPARAR VARIÃVEIS PARA EMAIL ====================

      - name: ðŸ“… Set Date/Timestamp Variables
        id: datetime
        if: steps.sync.outcome == 'success'
        run: |
          echo "current_date=$(date '+%d/%m/%Y Ã s %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "current_timestamp=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      # ==================== EMAIL SUCESSO ====================

      - name: ðŸ“§ Send Success Email
        if: steps.sync.outcome == 'success' && steps.git_commit.outputs.commit_status == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'âœ… SincronizaÃ§Ã£o CalendÃ¡rios Completa'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.EMAIL_USER }}
          body: |
            SincronizaÃ§Ã£o de calendÃ¡rios concluÃ­da com sucesso!

            âœ… Status: OK

            ðŸ“… Data: ${{ steps.datetime.outputs.current_date }}

            â° Timestamp: ${{ steps.datetime.outputs.current_timestamp }}

            ðŸ“Š Eventos processados:
            â€¢ Airbnb: âœ…
            â€¢ Booking: âœ…
            â€¢ Vrbo: âœ…

            ðŸ“ Ficheiro Atualizado no RepositÃ³rio

            ðŸ”— Link do RepositÃ³rio:
            ${{ github.server_url }}/${{ github.repository }}

            ðŸ“‹ Detalhes da ExecuÃ§Ã£o:
            Run ID: ${{ github.run_id }}
            Branch: main
            Commit: ${{ github.sha }}

            PrÃ³ximo passo: Aguardar sincronizaÃ§Ã£o automÃ¡tica das plataformas de reserva

      # ==================== EMAIL ERRO ====================

      - name: ðŸ“… Set Date/Timestamp Variables (Error)
        id: datetime_error
        if: failure()
        run: |
          echo "current_date=$(date '+%d/%m/%Y Ã s %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "current_timestamp=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: ðŸ“§ Send Error Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'âŒ Erro na SincronizaÃ§Ã£o CalendÃ¡rios'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.EMAIL_USER }}
          body: |
            Erro detectado na sincronizaÃ§Ã£o de calendÃ¡rios!

            âŒ Status: ERRO

            ðŸ“… Data: ${{ steps.datetime_error.outputs.current_date }}

            â° Timestamp: ${{ steps.datetime_error.outputs.current_timestamp }}

            ðŸ”— Link: ${{ steps.datetime_error.outputs.run_url }}

            ðŸ“‹ Verifique o log para detalhes:

            ---LOG---
            $(cat sync.log 2>/dev/null || echo "Log nÃ£o disponÃ­vel")
            ---END---

            âš ï¸ AÃ§Ã£o necessÃ¡ria: Verifique o log da execuÃ§Ã£o

      # ==================== ESTATÃSTICAS ====================

      - name: ðŸ“ˆ Log Statistics
        if: always()
        run: |
          echo "=== SINCRONIZAÃ‡ÃƒO STATISTICS ==="
          echo "Data/Hora: $(date '+%d/%m/%Y %H:%M:%S')"
          echo "Status: ${{ steps.sync.outcome }}"
          echo "Git Commit Status: ${{ steps.git_commit.outputs.commit_status }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "=== LOG SUMMARY ==="
          tail -20 sync.log || echo "Sem log disponÃ­vel"
          echo ""
          echo "=== FICHEIROS GERADOS ==="
          ls -lh master_calendar.ics 2>/dev/null || echo "Sem ficheiro ICS"
          ls -lh sync.log 2>/dev/null || echo "Sem sync.log"

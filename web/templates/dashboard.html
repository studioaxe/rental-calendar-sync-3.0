{% extends "base.html" %}

{% block title %}Dashboard - Calendário Sync{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2 mb-1">
                <i class="bi bi-speedometer2"></i> Dashboard
            </h1>
            <p class="text-muted">Sincronização de Calendários - Painel de Controlo</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-question-circle"></i> Ajuda
                </button>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <!-- Status Card -->
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle text-muted mb-2">
                                <i class="bi bi-gear"></i> Status do Workflow
                            </h6>
                            <h3 class="mb-1" id="statusBadge">
                                <span class="badge bg-secondary">Carregando...</span>
                            </h3>
                        </div>
                        <i class="bi bi-clock-history text-muted fs-4"></i>
                    </div>
                    <small class="text-muted" id="statusTime">Nunca executado</small>
                </div>
            </div>
        </div>

        <!-- Last Execution Card -->
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle text-muted mb-2">
                                <i class="bi bi-calendar-check"></i> Última Execução
                            </h6>
                            <h3 class="mb-1" id="lastExecution">-</h3>
                        </div>
                        <i class="bi bi-check-circle text-success fs-4"></i>
                    </div>
                    <small class="text-muted" id="lastExecutionTime">Sem histórico</small>
                </div>
            </div>
        </div>

        <!-- GitHub Config Card -->
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle text-muted mb-2">
                                <i class="bi bi-github"></i> GitHub Status
                            </h6>
                            <h3 class="mb-1" id="githubStatus">
                                <span class="badge bg-warning">Verificando...</span>
                            </h3>
                        </div>
                        <i class="bi bi-cloud-check text-info fs-4"></i>
                    </div>
                    <small class="text-muted" id="githubMessage">A conectar...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Section -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-play-circle"></i> Disparar Sincronização
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Clique no botão abaixo para disparar manualmente a sincronização de calendários através do GitHub Actions.
                    </p>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-lg" id="triggerBtn">
                            <i class="bi bi-play-fill"></i> Disparar Sincronização
                        </button>
                    </div>

                    <div id="triggerLoading" class="mt-3 text-center d-none">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">A carregar...</span>
                        </div>
                        <p class="mt-2 text-muted">A disparar workflow...</p>
                    </div>

                    <div id="triggerSuccess" class="alert alert-success mt-3 d-none" role="alert">
                        <i class="bi bi-check-circle"></i>
                        <strong>Sucesso!</strong> Workflow disparado com sucesso. Verifique o GitHub para mais detalhes.
                    </div>

                    <div id="triggerError" class="alert alert-danger mt-3 d-none" role="alert">
                        <i class="bi bi-exclamation-circle"></i>
                        <strong>Erro!</strong> <span id="errorMessage"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Informações
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Versão:</dt>
                        <dd class="col-sm-6">1.0</dd>
                        
                        <dt class="col-sm-6">Ambiente:</dt>
                        <dd class="col-sm-6">
                            <span class="badge bg-success">Produção</span>
                        </dd>
                        
                        <dt class="col-sm-6">Utilizador:</dt>
                        <dd class="col-sm-6">{{ username }}</dd>
                        
                        <dt class="col-sm-6">Data:</dt>
                        <dd class="col-sm-6" id="currentDate">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- History Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Histórico de Execuções
                    </h5>
                </div>
                <div class="card-body">
                    <div id="historyLoading" class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">A carregar...</span>
                        </div>
                        <p class="mt-2 text-muted">A carregar histórico...</p>
                    </div>

                    <table id="historyTable" class="table table-hover d-none">
                        <thead class="table-light">
                            <tr>
                                <th>Data/Hora</th>
                                <th>Status</th>
                                <th>Conclusão</th>
                                <th>Duração</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                        </tbody>
                    </table>

                    <div id="noHistory" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">Nenhum histórico disponível</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-bottom">
                <h5 class="modal-title">
                    <i class="bi bi-question-circle"></i> Ajuda - Como Usar
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>O que é o Calendário Sync?</h6>
                <p>O Calendário Sync é um sistema que sincroniza automaticamente calendários através do GitHub Actions.</p>

                <h6 class="mt-3">Como usar?</h6>
                <ol>
                    <li>Verifique o status do workflow no painel acima</li>
                    <li>Clique em "Disparar Sincronização" para executar manualmente</li>
                    <li>Consulte o histórico de execuções para ver resultados anteriores</li>
                </ol>

                <h6 class="mt-3">Dúvidas?</h6>
                <p>Contacte o administrador do sistema para suporte.</p>
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', loadDashboard);
    
    // Trigger button
    document.getElementById('triggerBtn').addEventListener('click', triggerWorkflow);
    
    // Update current date
    updateCurrentDate();
    setInterval(updateCurrentDate, 60000); // Update every minute
    
    // Auto-refresh every 30 seconds
    setInterval(loadDashboard, 30000);
});

function loadDashboard() {
    // Cargar status
    fetch('/api/workflow-status')
        .then(r => r.json())
        .then(data => updateStatusCard(data))
        .catch(e => console.error('Erro ao carregar status:', e));
    
    // Cargar histórico
    fetch('/api/workflow-history?limit=10')
        .then(r => r.json())
        .then(data => updateHistoryTable(data))
        .catch(e => console.error('Erro ao carregar histórico:', e));
}

function updateStatusCard(data) {
    const statusBadge = document.getElementById('statusBadge');
    const statusTime = document.getElementById('statusTime');
    
    if (data.status === 'no_runs') {
        statusBadge.innerHTML = '<span class="badge bg-secondary">Não executado</span>';
        statusTime.textContent = 'Nunca foi executado';
    } else {
        const statusClass = {
            'completed': 'bg-success',
            'in_progress': 'bg-info',
            'queued': 'bg-warning'
        }[data.status] || 'bg-secondary';
        
        const statusText = {
            'completed': 'Completo',
            'in_progress': 'Em execução',
            'queued': 'Enfileirado'
        }[data.status] || data.status;
        
        statusBadge.innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;
        const date = new Date(data.updated_at);
        statusTime.textContent = `Atualizado: ${date.toLocaleString('pt-PT')}`;
    }
}

function updateHistoryTable(data) {
    const historyTable = document.getElementById('historyTable');
    const historyBody = document.getElementById('historyBody');
    const historyLoading = document.getElementById('historyLoading');
    const noHistory = document.getElementById('noHistory');
    
    if (!data.history || data.history.length === 0) {
        historyTable.classList.add('d-none');
        historyLoading.classList.add('d-none');
        noHistory.classList.remove('d-none');
        return;
    }
    
    historyBody.innerHTML = data.history.map(run => `
        <tr>
            <td><small>${new Date(run.created_at).toLocaleString('pt-PT')}</small></td>
            <td><span class="badge ${run.status === 'completed' ? 'bg-success' : 'bg-info'}">${run.status}</span></td>
            <td>${run.conclusion || '-'}</td>
            <td>${run.duration ? Math.round(run.duration) + 's' : '-'}</td>
            <td>
                <a href="${run.html_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </td>
        </tr>
    `).join('');
    
    historyLoading.classList.add('d-none');
    noHistory.classList.add('d-none');
    historyTable.classList.remove('d-none');
}

function triggerWorkflow() {
    const btn = document.getElementById('triggerBtn');
    const loading = document.getElementById('triggerLoading');
    const success = document.getElementById('triggerSuccess');
    const error = document.getElementById('triggerError');
    
    // Reset
    success.classList.add('d-none');
    error.classList.add('d-none');
    
    // Show loading
    btn.disabled = true;
    loading.classList.remove('d-none');
    
    fetch('/api/trigger-workflow', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                success.classList.remove('d-none');
                setTimeout(() => loadDashboard(), 2000);
            } else {
                error.classList.remove('d-none');
                document.getElementById('errorMessage').textContent = data.error || 'Erro desconhecido';
            }
        })
        .catch(e => {
            error.classList.remove('d-none');
            document.getElementById('errorMessage').textContent = 'Erro de conexão';
        })
        .finally(() => {
            btn.disabled = false;
            loading.classList.add('d-none');
        });
}

function updateCurrentDate() {
    const date = new Date();
    document.getElementById('currentDate').textContent = date.toLocaleString('pt-PT');
}
</script>
{% endblock %}